{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlowFin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/creditor/history.css' %}">
<link rel="icon" href="{% static 'img/icon.ico' %}" type="image/x-icon">
</head>
<body>

<nav>
    <h1><a href="/">FlowFin</a></h1>
    <select onchange="navigate(this)">
        <option value="/">-------------------</option>
        <option value="/">Menyu</option>
        <option value="/create_loan">Arizani yuborish</option>
        <option value="/requests">Arizalar tarixi</option>
    </select>
    <a href="{% url 'auth:logout' %}" class="user">{{ user.full_name }}</a>
</nav>

<main class="main">
    <div class="card">
        <h2>Arizalar Tarixi</h2>
        <form class="search-bar" method="get">
            <input type="search" id="searchInput" name="q" value="{{q}}" placeholder="ID, PINFL yoki Ism bo‘yicha izlash">
            <button type="submit">Qidirish</button>
        </form>

        <table id="historyTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Mijoz F.I.O</th>
                    <th>PINFL</th>
                    <th>Mahsulot</th>
                    <th>Jami summa</th>
                    <th>Filial</th>
                    <th>Status</th>
                    <th>Amallar</th>
                </tr>
            </thead>
            <tbody>
                <!-- Example static data -->
                 {% for i in loans %}
                <tr>
                    <td>{{i.contract_id}}</td>
                    <td>{{i.client.full_name}}</td>
                    <td>{{i.client.passport_pinfl}}</td>
                    <td>{{i.product.name}}</td>
                    <td>{{i.total_amount|intcomma}} so‘m</td>
                    <td>{{i.filial.name}}</td>
                    {% if i.status == "pending" %}
                        <td style="color: rgb(189, 189, 10);">Jarayonda</td>
                    {% elif i.status == "rejected" %}
                        <td style="color: rgb(184, 0, 0);">Rad etilgan</td>
                    {% elif i.status == "paid" %}
                        <td style="color: rgb(0, 0, 0);">Yopilgan</td>
                    {% elif i.status == "done" %}
                        <td style="color: rgb(32, 206, 90);">Berilgan</td>
                    {% elif i.status == "approved" %}
                        <td style="color: rgb(27, 95, 6);">Tasdiqlangan</td>
                    {% endif %}
                    <td><a href="{% url 'konveyer' i.id %}" style="text-decoration: none;" class="view-btn" onclick="viewRequest(1)">View</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p id="noData" class="no-data" style="display:none;">Hech qanday ariza topilmadi.</p>
    </div>
</main>

<script>
function navigate(sel){
    if(sel.value) window.location.href = sel.value;
}

// ===== SEARCH FUNCTION =====
function searchTable(){
    const input = document.getElementById("searchInput").value.toLowerCase();
    const table = document.getElementById("historyTable");
    const rows = table.getElementsByTagName("tr");
    let visibleCount = 0;

    for(let i=1;i<rows.length;i++){
        const cells = rows[i].getElementsByTagName("td");
        let match = false;
        for(let j=1;j<=2;j++){ // F.I.O or PINFL
            if(cells[j].innerText.toLowerCase().includes(input)){
                match = true;
                break;
            }
        }
        rows[i].style.display = match ? "" : "none";
        if(match) visibleCount++;
    }

    document.getElementById("noData").style.display = visibleCount===0 ? "block" : "none";
}

// ===== VIEW REQUEST =====
</script>

</body>
</html>
