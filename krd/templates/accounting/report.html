{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hisobotlar – FlowFin</title>
<link rel="icon" href="{% static 'img/icon.ico' %}" type="image/x-icon">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="icon" href="{% static 'img/icon.ico' %}" type="image/x-icon">
<link rel="stylesheet" href="{% static 'css/accounting/report.css' %}">
</head>

<body>

<header class="topbar">
    <a style="text-decoration: none;color: white;" href="{% url 'accounting:home' %}"><h1>Hisobotlar | Jami: {{payments.count}}</h1></a>
</header>

<main class="container">

<!-- Filters -->
<div class="card">
    <form class="filters" method="get">
        <label>
            Boshlanish sana:
            <input type="date" id="fromDate" name="start_date" value="{{start_date}}">
        </label>
        <label>
            Tugash sana:
            <input type="date" id="toDate" name="end_date" value="{{end_date}}">
        </label>
        <label>
            Qidirish:
            <input type="text" id="searchQuery" name="contract_id" value="{{contract_id}}" placeholder="Mijoz yoki kredit №">
        </label>
        <button type="submit">Ko‘rsatish</button>
        <button onclick="printReport()">Print</button>
    </form>
</div>

<!-- Report Table -->
<div class="card" id="printable">
    <table id="reportTable">
        <thead>
            <tr>
                <th>Sana</th>
                <th>Kredit №</th>
                <th>Mijoz</th>
                <th>Summa</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% if payments %}
                {% for i in payments %}
                    <tr>
                        <td>{{i.payment_date}}</td>
                        <td><a href="{% url 'accounting:payment' %}?q={{i.loan.contract_id}}" style="color: black;">{{i.loan.contract_id}}</a></td>
                        <td>{{i.loan.client.full_name}}</td>
                        <td>{{i.payment|intcomma}} so'm</td>
                        {% if i.is_paid %}
                            <td><span class="badge paid">To‘langan</span></td>
                        {% else %}
                            <td><span class="badge unpaid">To‘lanmagan</span></td>
                        {% endif %}
                    </tr>
                {% endfor %}
            {% endif %}
        </tbody>
    </table>
</div>

</main>

<script>
// Filter table by date and search
function filterTable() {
    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;
    const search = document.getElementById("searchQuery").value.toLowerCase();
    const table = document.getElementById("reportTable");
    const trs = table.tBodies[0].rows;

    for (let row of trs) {
        const date = row.cells[0].textContent;
        const contract = row.cells[1].textContent.toLowerCase();
        const client = row.cells[2].textContent.toLowerCase();
        let show = true;

        if (from && date < from) show = false;
        if (to && date > to) show = false;
        if (search && !(contract.includes(search) || client.includes(search))) show = false;

        row.style.display = show ? "" : "none";
    }
}

// Print button
function printReport() {
    window.print();
}
</script>

</body>
</html>
